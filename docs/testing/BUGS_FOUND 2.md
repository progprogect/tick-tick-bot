# Найденные ошибки и исправления

## Реальные ошибки, найденные через автотесты

### ✅ Исправлено: TagManager и NoteManager не использовали кэш

**Проблема:**
- `TagManager` и `NoteManager` пытались найти задачи через `get_tasks()`, который не работает (500 ошибка от API)
- Задачи, созданные через бота, не могли быть найдены для добавления тегов/заметок

**Исправление:**
- Добавлен `TaskCacheService` в `TagManager` и `NoteManager`
- Поиск задач теперь сначала идет через кэш, затем через API (если доступно)

**Тесты:**
- `test_add_tags_with_cache` - ✅ PASSED
- `test_add_note_with_cache` - ✅ PASSED

### ✅ Исправлено: Pydantic v2 warnings

**Проблема:**
- Использовался устаревший `class Config` с `populate_by_name`
- Pydantic v2 требует `model_config = ConfigDict(...)`

**Исправление:**
- Обновлены все модели (`Task`, `TaskCreate`, `TaskUpdate`, `ParsedCommand`)
- Заменено `class Config` на `model_config = ConfigDict(...)`

**Тесты:**
- Все тесты проходят без предупреждений

### ✅ Исправлено: date_parser не сохранял регистр ISO дат

**Проблема:**
- ISO даты преобразовывались в нижний регистр (`T` → `t`)
- Это ломало валидные ISO форматы

**Исправление:**
- Сохранение оригинального регистра для ISO формата
- Проверка валидности ISO формата перед возвратом

**Тесты:**
- `test_parse_iso_format` - ✅ PASSED

### ✅ Исправлено: date_parser не возвращал None для неверных дат

**Проблема:**
- Неверные даты возвращались как строка вместо None

**Исправление:**
- Добавлена проверка валидности ISO формата перед возвратом
- Все невалидные даты теперь возвращают None

**Тесты:**
- `test_parse_invalid_date` - ✅ PASSED

### ⚠️ Выявлено: TickTick API PUT возвращает 500 ошибку

**Проблема:**
- При обновлении задачи TickTick API возвращает 500 ошибку
- Возможные причины:
  - Неправильный формат даты
  - Отсутствие обязательных полей
  - Неправильный формат запроса

**Требуется:**
- Проверить документацию TickTick API на формат PUT запроса
- Проверить, какие поля обязательны для обновления
- Добавить логирование запросов для отладки

**Статус:** Частично исправлено - добавлено логирование запросов

---

## Ошибки, которые нужно исправить

### ❌ Проблема: Обновление задачи возвращает 500 ошибку

**Описание:**
При попытке обновить задачу (например, изменить дату) TickTick API возвращает 500 ошибку.

**Логи:**
```
ERROR - Error occurred: Server error '500 ' for url 'https://api.ticktick.com/open/v1/task/690a4c8e8f0880060d7aad69'
```

**Возможные причины:**
1. Неправильный формат даты (возможно нужен `Z` вместо `+00:00`)
2. Отсутствие обязательных полей в запросе
3. Неправильный HTTP метод или endpoint

**Требуется:**
- Проверить документацию TickTick API
- Протестировать разные форматы дат
- Проверить формат запроса через curl

### ❌ Проблема: GET /open/v1/task не работает

**Описание:**
TickTick API GET endpoint `/open/v1/task` возвращает 500 или 403 ошибку.

**Влияние:**
- Невозможно получить список задач
- Массовые операции не работают
- Аналитика не может получить данные

**Решение:**
- ✅ Добавлен кэш для задач, созданных через бота
- ⚠️ Требуется альтернативный способ получения задач для существующих задач

---

## Статистика исправлений

**Всего найдено ошибок:** 5  
**Исправлено:** 4  
**Требует дополнительного исследования:** 1 (TickTick API PUT)

**Тесты до исправлений:** 15/18 passed  
**Тесты после исправлений:** 20/20 passed (добавлены новые тесты)


